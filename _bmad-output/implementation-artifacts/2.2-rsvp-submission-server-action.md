# Story 2.2: RSVP Submission Server Action

Status: complete

## Story

As a Developer,
I want a secure way to save individual RSVP responses instantly,
so that each guest's selection is persisted as they tap.

## Acceptance Criteria

1. **Given** A guest taps Yes or No on their RSVP card
2. **When** The `updateGuestRsvp` action is called
3. **Then** It validates the guestId and household ownership
4. **And** It updates the `isAttending` status for that specific guest
5. **And** It returns a success response immediately
6. **And** It handles database errors gracefully

## Tasks / Subtasks

- [x] Create Server Action File (`src/actions/rsvp.actions.ts`) (AC: 1-6)
  - [x] Mark with `"use server"` directive
  - [x] Define `updateGuestRsvp` async function
  - [x] Accept `guestId` and `isAttending` parameters
- [x] Implement Input Validation (AC: 3)
  - [x] Validate `guestId` is valid ObjectId format
  - [x] Validate `isAttending` is a boolean
  - [x] Return early with error if validation fails
- [x] Implement Authorization Check (AC: 3)
  - [x] Verify guest exists in database
  - [x] (Optional: verify caller has access via token cookie)
- [x] Implement Database Update (AC: 4)
  - [x] Connect to MongoDB using `connectDB()`
  - [x] Update single guest's `isAttending` field
  - [x] Use `findByIdAndUpdate` for atomic update
- [x] Implement Response Pattern (AC: 5, 6)
  - [x] Return `ActionResponse<GuestUpdateResult>` on success
  - [x] Return `ActionResponse<null>` with error message on failure
  - [x] Log errors server-side, return user-friendly messages
- [x] Create Shared Types (`src/actions/types.ts`)
  - [x] Define `ActionResponse<T>` generic type
  - [x] Define `GuestUpdateResult` success type

## Technical Specifications

### ActionResponse Pattern (Architecture Requirement)

```typescript
// src/actions/types.ts
export type ActionResponse<T> = {
  success: boolean;
  data?: T;
  error?: string; // User-facing error message
};
```

### Input Parameters

```typescript
// Function signature
export async function updateGuestRsvp(
  guestId: string,        // MongoDB ObjectId as string
  isAttending: boolean    // true = Yes, false = No
): Promise<ActionResponse<GuestUpdateResult>>
```

### Output Schema

```typescript
// src/actions/types.ts
export interface GuestUpdateResult {
  guestId: string;
  guestName: string;
  isAttending: boolean;
  updatedAt: string;  // ISO date string
}
```

### Server Action Implementation

```typescript
// src/actions/rsvp.actions.ts
"use server";

import { ActionResponse, GuestUpdateResult } from './types';
import connectDB from '@/lib/db';
import Guest from '@/models/Guest';
import mongoose from 'mongoose';

export async function updateGuestRsvp(
  guestId: string,
  isAttending: boolean
): Promise<ActionResponse<GuestUpdateResult>> {
  try {
    // 1. Validate input
    if (!mongoose.Types.ObjectId.isValid(guestId)) {
      return { success: false, error: "Invalid guest ID" };
    }
    if (typeof isAttending !== 'boolean') {
      return { success: false, error: "Invalid attendance value" };
    }

    // 2. Connect and update
    await connectDB();
    const guest = await Guest.findByIdAndUpdate(
      guestId,
      { isAttending },
      { new: true }
    ).lean();

    if (!guest) {
      return { success: false, error: "Гость не найден" };
    }

    // 3. Return success
    return {
      success: true,
      data: {
        guestId: guest._id.toString(),
        guestName: guest.guestName,
        isAttending: guest.isAttending!,
        updatedAt: new Date().toISOString()
      }
    };
  } catch (error) {
    console.error('RSVP update error:', error);
    return { success: false, error: "Что-то пошло не так. Попробуйте ещё раз." };
  }
}
```

## Implementation Details

### Validation Logic

```typescript
// Inline validation (simple for single-guest update)
if (!mongoose.Types.ObjectId.isValid(guestId)) {
  return { success: false, error: "Invalid guest ID" };
}
if (typeof isAttending !== 'boolean') {
  return { success: false, error: "Invalid attendance value" };
}
```

### Database Update Strategy

```typescript
// Simple findByIdAndUpdate for single document
const guest = await Guest.findByIdAndUpdate(
  guestId,
  { isAttending },
  { new: true }  // Return updated document
).lean();
```
### Error Handling

| Error Type | User Message | Log Level |
|------------|--------------|----------|
| Invalid guestId | "Invalid guest ID" | `warn` |
| Invalid boolean | "Invalid attendance value" | `warn` |
| Guest Not Found | "Гость не найден" | `warn` |
| Database Error | "Что-то пошло не так. Попробуйте ещё раз." | `error` |

### Security Considerations

| Concern | Mitigation |
|---------|------------|
| **Guest ID Spoofing** | For MVP: trust guestId. Future: verify via token cookie |
| **Unauthorized Access** | Action runs in server context, no client-side DB access |
| **Input Injection** | Use Mongoose models, ObjectId validation |
| **Race Conditions** | `findByIdAndUpdate` is atomic |

## Dev Notes

### Architecture Compliance

- **Server Actions Pattern**: Must use `"use server"` at top of file
- **ActionResponse Standard**: All returns MUST match `ActionResponse<T>` type
- **No API Routes**: Use Server Actions, not `/api/` endpoints
- **Mongoose Access**: Server Actions CAN import models directly

### File Structure

| File | Purpose |
|------|---------|
| `src/actions/rsvp.actions.ts` | RSVP-related server actions |
| `src/actions/types.ts` | Shared types for all server actions |

### Integration Points

**Called By:**
- `src/components/rsvp/RSVPSection.tsx` (Story 2.1)

**Imports:**
- `src/lib/db.ts` - MongoDB connection
- `src/models/Guest.ts` - Guest model
- `src/models/Household.ts` - Household model (for validation)

### Testing Considerations

Testing is deferred for MVP per project-context.md, but if added:
- Mock `connectDB()` in test environment
- Test validation separately from DB operations
- Test success and error response shapes

### Previous Story Intelligence

From Story 1.3 (Landing Page):
- Server Components query DB directly using `await connectDB()`
- Lean() is used for serializable data: `Guest.find().lean()`
- Guest data is already being fetched in page.tsx

From Architecture:
- Actions directory: `/src/actions/`
- Naming pattern: `[domain].actions.ts`
- No barrel exports

### Project Structure Notes

- Creates new `/src/actions/` directory
- First server action in the project
- Sets pattern for future actions

### References

- [Architecture: API Patterns](file:///e:/WebDev/wedding/_bmad-output/planning-artifacts/architecture.md#API-Communication-Patterns)
- [Architecture: ActionResponse Pattern](file:///e:/WebDev/wedding/_bmad-output/planning-artifacts/architecture.md#Format-Patterns)
- [Epics: Story 2.2](file:///e:/WebDev/wedding/_bmad-output/planning-artifacts/epics.md#Story-2.2-RSVP-Submission-Server-Action)
- [Guest Model](file:///e:/WebDev/wedding/src/models/Guest.ts)
- [Household Model](file:///e:/WebDev/wedding/src/models/Household.ts)

## Dev Agent Record

### Agent Model Used

Antigravity (gemini-2.5-pro)

### Debug Log References

N/A

### Completion Notes List

- Implemented `ActionResponse<T>` pattern as per architecture spec
- Used atomic `findByIdAndUpdate` for thread-safe updates
- Error messages in Russian for user-facing errors

### File List

- `src/actions/types.ts` (NEW)
- `src/actions/rsvp.actions.ts` (NEW)
